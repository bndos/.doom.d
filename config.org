* Appearance
#+BEGIN_SRC emacs-lisp
;; (setq fancy-splash-image "~/.doom.d/splash.png")
(defun my-custom-banner ()
  (let* ((banner
          '(" .-._                                                   _,-,"
            "  `._`-._                                           _,-'_,"
            "     `._ `-._                                   _,-' _,"
            "        `._  `-._        __.-----.__        _,-'  _,"
            "           `._   `#===\"\"           \"\"===#'   _,"
            "              `._/)  ._               _.  (\\_,"
            "               )*'     **.__     __.**     '*( "
            "               #  .==..__  \"\"   \"\"  __..==,  # "
            ""
            ""
            ""
            ""
            ""
            ""
            ""
            ""
            ""
            ""
            ))
         (longest-line (apply #'max (mapcar #'length banner))))
    (put-text-property
     (point)
     (dolist (line banner (point))
       (insert (+doom-dashboard--center
                +doom-dashboard--width
                (concat
                 line (make-string (max 0 (- longest-line (length line)))
                                   32)))
               "\n"))
     'face 'doom-dashboard-banner)))

(setq +doom-dashboard-ascii-banner-fn 'my-custom-banner)



(setq display-line-numbers-type nil)
(global-visual-line-mode t)
(setq warning-minimum-level :emergency)

;; Color on compile buffer
(require 'ansi-color)
(defun my/ansi-colorize-buffer ()
  (let ((buffer-read-only nil))
    (ansi-color-apply-on-region (point-min) (point-max))))
(add-hook 'compilation-filter-hook 'my/ansi-colorize-buffer)
;; Theme
(setq doom-theme 'doom-dracula)
(setq! doom-font (font-spec :family "Monego" :style "Bold" :size 25)
       doom-variable-pitch-font (font-spec :family "Monego" :style "Bold" :size 25)
       doom-big-font (font-spec :family "Monego" :style "Bold" :size 28))
(setq! doom-unicode-font (font-spec :family "MesloLGS NF" :size 25))
(set-fontset-font "fontset-default" '(#xf000 . #xf23a) "all-the-icons")

;; set default height and width
(add-to-list 'default-frame-alist '(height . 75))
;; (add-to-list 'default-frame-alist '(width . 290))

(add-to-list 'default-frame-alist
             '(font . "Monego-10"))


(add-to-list 'default-frame-alist '(alpha-background . 80))

(set-frame-parameter (selected-frame) 'alpha-background 0.8)
;; (set-frame-parameter nil 'alpha-background 80)

(setq-default header-line-format " ")
(set-fringe-mode 25)
(setq-default left-fringe-width  25)
(setq-default right-fringe-width 25)

(setq doom-themes-enable-bold t
      doom-themes-enable-italic nil)

;; (after! doom-modeline
;;   (setq doom-modeline-buffer-file-name-style 'file-name)
;;   (setq-default doom-modeline-height 45)
;;   (doom-modeline-def-modeline 'main
;;     '(bar window-number matches buffer-info remote-host buffer-position selection-info)
;;     '(objed-state misc-info persp-name irc mu4e github debug input-method buffer-encoding lsp major-mode process vcs checker "  ")))

(use-package! spaceline
  :config
  (spaceline-emacs-theme)
  (setq powerline-default-separator 'wave)
  (setq powerline-height 40)
  ;; disable minor modes
  (setq spaceline-minor-modes-p nil)
  ;; spaceline-evil-state-faces
  (setq spaceline-highlight-face-func 'spaceline-highlight-face-evil-state)
  (spaceline-compile)
  ;; spaceline-face-func
  )

(custom-set-faces!
  '(default :background "#000000" :foreground "#ffffff")
  '(ivy-minibuffer-match-face-1 :background "#ff79c6" :foreground "#000000")
  '(ivy-minibuffer-match-face-2 :background "#ff79c6" :foreground "#000000")
  '(ivy-minibuffer-match-face-3 :background "#ff79c6" :foreground "#000000")
  '(ivy-minibuffer-match-face-4 :background "#ff79c6" :foreground "#000000")
  '(ivy-minibuffer-match-face-4 :background "#ff79c6" :foreground "#000000")
  '(mc/cursor-bar-face :foreground "#ff79c6")
  '(doom-dashboard-banner :foreground "#ff9090")
  '(tree-sitter-hl-face:type.builtin :inherit 'font-lock-type-face)
  '(header-line :background "#000000")
  '(ein:basecell-input-area-face :background "#191919")
  '(markdown-code-face :inherit default)

  '(magit-header-line :background nil :box nil)
  ;; better ediff colors for dark theme
  '(ediff-current-diff-A :background "#773333")
  '(ediff-current-diff-B :background "#337733")
  '(ediff-current-diff-C :background "#333377")


  '(match :background nil)
  '(org-block-begin-line :background nil)
  '(org-block :background nil)
  '(org-block-end-line :background nil)
  '(whitespace-tab :background nil)
  '(whitespace-space :background nil)
  '(mode-line :background "#101010")
  '(mode-line-inactive :background nil)
  '(ivy-virtual :foreground "#444444" :italic nil)
  '(ivy-current-match :background "#ff79c6" :foreground "#000000" :inherit bold)
  '(font-lock-comment-face :foreground "#444444")
  '(font-lock-variable-name-face :foreground "#ffb86c")
  '(hl-line :background "#171717")
  ;; '(region :background "#355461")
  '(lsp-ui-peek-highlight :background "#355461")

  '(mode-line :background "#101010" :box nil)
  '(mode-line-active :background "#050505")
  '(mode-line-inactive :background "#000000" :box nil)
  '(powerline-active0 :background "#202020")
  '(powerline-active1 :background "#202020")
  '(powerline-active2 :background "#050505")
  '(powerline-inactive0 :background "#000000")
  '(powerline-inactive1 :background "#000000")
  '(powerline-inactive2 :background "#050505")

  '(spaceline-evil-normal :background "#ff79c6" :foreground "#000000")
  '(spaceline-evil-insert :foreground "#000000")
  '(spaceline-evil-emacs :foreground "#000000")
  '(spaceline-evil-visual :background "#8be9fd" :foreground "#000000")

  '(region :background "#282222")
  '(xref-match :foreground "#ff79c6" :inherit bold)

  '(highlight :background "#ff79c6" :foreground "#000000" :inherit bold)

  '(company-tooltip :background "#101010")
  '(company-tooltip-common-selection :background "#ff79c6" :foreground "#000000" :inherit bold)
  '(company-tooltip-selection :background "#ff79c6" :foreground "#000000" :inherit bold)

  )

(global-set-key (kbd "s-N") 'flash-active-buffer)
(make-face 'flash-active-buffer-face)
(set-face-attribute 'flash-active-buffer-face nil
                    :background "#151515" :foreground nil)
(defun flash-active-buffer ()
  (interactive)
  (run-at-time "100 millisec" nil
               (lambda (remap-cookie)
                 (face-remap-remove-relative remap-cookie))
               (face-remap-add-relative 'default 'flash-active-buffer-face)))

(setq window-divider-default-bottom-width 0)

(use-package! tree-sitter
  :config
  (require 'tree-sitter-langs)
  (global-tree-sitter-mode)
  (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode))
#+END_SRC

* git-gutter-fringe
#+BEGIN_SRC emacs-lisp
(after! git-gutter-fringe
  (set-face-foreground 'git-gutter-fr:modified  "purple")
  
  (fringe-helper-define 'git-gutter-fr:deleted nil
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "........"
    "XXXXXXXX"
    "XXXXXXXX"
    "XXXXXXXX"
    "XXXXXXXX"))
#+END_SRC

* evil
#+BEGIN_SRC emacs-lisp
;; evil
(setq evil-insert-state-map (make-sparse-keymap))
(define-key evil-insert-state-map (kbd "<escape>") 'evil-normal-state)
#+END_SRC

* persp-mode
#+BEGIN_SRC emacs-lisp
(after! persp-mode
                                        ; magit restore fix with persp-mode.el
  (persp-def-buffer-save/load
   :mode 'magit-status-mode :tag-symbol 'def-magit-status-buffer
   :save-vars '(default-directory)
   :load-function #'(lambda (savelist &rest _)
                      (cl-destructuring-bind (buffer-name vars-list &rest _rest) (cdr savelist)
                        (let ((buf-dir (alist-get 'default-directory vars-list)))
                          (magit-status buf-dir))))))
#+END_SRC

* counsel-projectile
#+BEGIN_SRC emacs-lisp
;; counsel-projectile
(setq recentf-menu-filter 'recentf-show-basenames)

(after! counsel-projectile
  (ivy-set-display-transformer
   'counsel-projectile-find-file
   'counsel-projectile-find-file-transformer)
  (setq projectile-indexing-method 'hybrid)
  )

(after! ivy
  (setq ivy-sort-max-size 30000)
  ;; (setq ivy-ignore-buffers '("\\` " "\\`\\*" "^magit:"))
  (map! :map ivy-mode-map "C-k" #'ivy-switch-buffer-kill)
  (setq ivy-count-format "(%d/%d) ")
  (setq ivy-use-virtual-buffers t)
  ;; abbreviate ivy virtual buffers
  (setq ivy-virtual-abbreviate 'abbreviate)
  )
#+END_SRC

* webkit-color-picker
#+BEGIN_SRC emacs-lisp
;; webkit-color-picker
(use-package! webkit-color-picker
  :ensure t
  :bind (("C-c w" . webkit-color-picker-show))
 )
#+END_SRC

* lsp/flycheck
#+BEGIN_SRC emacs-lisp
;; lsp/flycheck
(setq gc-cons-threshold (* 100 1024 1024)
      read-process-output-max (* 1024 1024))
(setq lsp-enable-file-watchers nil)
(setq lsp-disabled-clients '(angular-ls))

(setq lsp-pyright-use-library-code-for-types t)
(setq lsp-pyright-disable-language-services nil)
(setq lsp-pyright-disable-organize-imports nil)
(setq lsp-pyright-auto-import-completions t)
(setq lsp-pyright-auto-search-paths t)
(setq lsp-pyright-diagnostic-mode "workspace")

(after! lsp-ui
  (map! :map lsp-ui-mode-map :n
        "g P" #'lsp-ui-peek-find-references)
  (map! :map lsp-ui-mode-map :leader
        "c g" #'lsp-ui-doc-show)
  (setq lsp-ui-sideline-enable nil)
  ;; (setq lsp-ui-sideline-ignore-duplicate t)
  ;; (setq lsp-ui-sideline-show-hover t)
  ;; (setq lsp-ui-sideline-show-symbol t)
  (setq lsp-ui-doc-enable nil)
  (setq lsp-ui-doc-position 'at-point)
  (setq lsp-ui-doc-show-with-mouse t)
  (setq lsp-ui-doc-alignment 'frame)
  (setq lsp-ui-doc-max-height 300)
  (setq lsp-ui-doc-max-width 1000)
  (setq lsp-lens-enable t)
  (setq lsp-ui-doc-include-signature t)
  
  (put 'lsp-ui-doc--handle-mouse-movement 'isearch-scroll t))

(after! lsp-clangd
  (set-lsp-priority! 'clangd 1))  ; ccls has priority 0

;; (add-hook 'lsp-mode-hook (lambda ()
;;                            (setq header-line-format nil)
;;                            (lsp-headerline-breadcrumb-mode)))
;; (add-hook 'lsp-after-open-hook (lambda ()
;;                                  (setq header-line-format nil)
;;                                  (lsp-headerline-breadcrumb-mode)))
;; (add-hook 'lsp-after-initialize-hook (lambda ()
;;                                        (setq header-line-format nil)
;;                                        (lsp-headerline-breadcrumb-mode)))
;; (add-hook 'lsp-after-uninitialized-hook (lambda ()
;;                                           (setq header-line-format nil)
;;                                           (lsp-headerline-breadcrumb-mode)))
(add-hook 'lsp-after-diagnostics-hook (lambda ()
                                        (lsp-headerline-breadcrumb-mode)))

(defvar-local my/flycheck-local-cache nil)

(defun my/flycheck-checker-get (fn checker property)
  (or (alist-get property (alist-get checker my/flycheck-local-cache))
      (funcall fn checker property)))

(advice-add 'flycheck-checker-get :around 'my/flycheck-checker-get)

(add-hook 'lsp-managed-mode-hook
          (lambda ()
            (when (or (derived-mode-p 'typescript-mode)
                      (string-equal "tsx" (file-name-extension buffer-file-name)))
              (setq my/flycheck-local-cache '((lsp . ((next-checkers . (typescript-tslint)))))))))

(add-hook 'lsp-managed-mode-hook
          (lambda ()
            (when (derived-mode-p 'js-mode)
              (setq my/flycheck-local-cache '((lsp . ((next-checkers . (javascript-eslint)))))))))

(add-hook 'lsp-managed-mode-hook
          (lambda ()
            (when (derived-mode-p 'python-mode)
              (setq my/flycheck-local-cache '((lsp . ((next-checkers . ('python-pyright '(warning . python-flake8))))))))))

(map! :leader "[" #'flycheck-previous-error)
(map! :leader "]" #'flycheck-next-error)
#+END_SRC

* dart
#+BEGIN_SRC emacs-lisp
;; dart
(use-package! dart-mode
  :bind (:map dart-mode-map
              ("C-M-x" . #'flutter-run-or-hot-reload)))
#+END_SRC

* prettier-js
#+BEGIN_SRC emacs-lisp
(add-hook 'js-mode-hook #'prettier-js-mode)
(add-hook 'typescript-mode-hook #'prettier-js-mode)
#+END_SRC

* dap-mode
#+BEGIN_SRC emacs-lisp
;; dap-mode
(after! dap-mode
  (require 'dap-gdb-lldb)
  (dap-gdb-lldb-setup)
  (setq dap-output-buffer-filter '("stdout"))
  (map! :leader "d d" #'dap-debug)
  (map! :leader "d b" #'dap-breakpoint-toggle)
  (map! :leader "d h" #'dap-hydra))
#+END_SRC

* ein
#+BEGIN_SRC emacs-lisp
(after! ein
  (setq ein:output-area-inlined-images t)
  (setq ein:slice-image t))
#+END_SRC

* go-mode
#+BEGIN_SRC emacs-lisp
;; go-mode
(after! go-mode
  (add-hook 'before-save-hook 'gofmt-before-save))
#+END_SRC

* company
#+BEGIN_SRC emacs-lisp
;; company
(after! company
  (setq company-idle-delay 0.01)
  (define-key company-mode-map (kbd "H-SPC") 'company-complete)
  (define-key company-active-map (kbd "<backtab>") 'counsel-company))
#+END_SRC

* js-react-redux-yasnippets
#+BEGIN_SRC emacs-lisp
;; js-react-redux-yasnippets
(after! js-react-redux-yasnippets
  (setq js-react-redux-yasnippets-want-semicolon t))
#+END_SRC

* treemacs
#+BEGIN_SRC emacs-lisp
;; treemacs
(after! treemacs
  (treemacs-follow-mode 1)
  (map! :leader "o s" #'lsp-treemacs-symbols)
  (setq treemacs-is-never-other-window nil)
  )
;; lsp-treemacs
#+END_SRC

* meson-mode
#+BEGIN_SRC emacs-lisp
;; meson-mode
(use-package! meson-mode
  :mode "\\.build\\'"
  )
#+END_SRC

* smartparens
#+BEGIN_SRC emacs-lisp
;; smartparens
(after! smartparens
  (define-key smartparens-mode-map (kbd "M-<backspace>") 'sp-backward-unwrap-sexp))
#+END_SRC

* multiple cursors
#+BEGIN_SRC emacs-lisp
;; multiple-cursors
(blink-cursor-mode 1)
(use-package! multiple-cursors
  :bind
  (("H-."  . 'mc/mark-next-like-this)
   ("H-,"  . 'mc/mark-previous-like-this)
   ("C-\"" . 'mc/mark-all-like-this)

   :map mc/keymap
   ("C->"     . 'mc/skip-to-next-like-this)
   ("C-<"     . 'mc/skip-to-previous-like-this)
   ("C-x C-." . 'mc/unmark-next-like-this)
   ("C-x C-," . 'mc/unmark-previous-like-this)
   ("C-x C-:" . 'mc/mark-pop)
   ("M-["     . 'mc/insert-numbers)
   ("M-]"     . 'mc/insert-letters)
   ("C-x C-a" . 'mc/vertical-align-with-space)))
#+END_SRC

* buffermove
#+BEGIN_SRC emacs-lisp
;; buffermove
(use-package! buffer-move
  :bind (("H-K" . buf-move-up)
         ("H-J" . buf-move-down)
         ("H-H" . buf-move-left)
         ("H-L" . buf-move-right)))
#+END_SRC

* dired
#+BEGIN_SRC emacs-lisp
;; dired
(after! dired-x
  (defun dired-open-in-external-app ()
    "Open the file(s) at point with an external application."
    (interactive)
    (let ((file-list (dired-get-marked-files)))
      (mapc
       (lambda (file-path)
         ;; (let ((process-connection-type nil))
         ;;   (start-process "" nil "gio" "open" file-path))
         ;; (start-process "" nil "gio" "open" file-path)
         (call-process "gio" nil 0 nil "open" file-path)
         (message file-path))
       file-list)))

  (define-key dired-mode-map (kbd "M-o")
    (lambda () (interactive) (dired-open-in-external-app))))

(add-hook 'dired-mode-hook
          (lambda ()
            (dired-hide-details-mode)))
#+END_SRC

* copilot
#+BEGIN_SRC emacs-lisp
;; copilot
(defun my-tab ()
  (interactive)
  (or (copilot-accept-completion)
      (company-indent-or-complete-common nil)))

(use-package! copilot
  :hook (prog-mode . copilot-mode)
  :bind (("S-<tab>" . 'copilot-accept-completion-by-word)
         ("S-<return>" . 'copilot-accept-completion)
         :map copilot-completion-map
         ("M-n" . 'copilot-next-completion)
         ("M-p" . 'copilot-previous-completion)
         ("TAB" . 'my-tab)
         ("S-<return>" . 'copilot-accept-completion)
         ("C-<tab>" . 'copilot-accept-completion-by-word)
         ("H-<tab>" . 'copilot-accept-completion-by-line)
         )
        (:map copilot-mode-map
         ("S-<tab>" . 'copilot-accept-completion-by-word)
         ))
#+END_SRC

* magit
#+BEGIN_SRC emacs-lisp
(after! magit
  (setq transient-display-buffer-action '(display-buffer-in-side-window (side . bottom))))
#+END_SRC

* window-rules
#+BEGIN_SRC emacs-lisp
;; window-rules
(defvar parameters
  '(window-parameters . ((no-delete-other-windows . t) (unsplittable . t) (no-other-window . nil)))
  )

(setq
 display-buffer-alist
 `(("\\*Buffer List\\*" display-buffer-in-side-window
    (side . bottom) (slot . 0) (window-height . fit-window-to-buffer) (dedicated . t)
    (preserve-size . (nil . t)) ,parameters)
   ("\\*\\(?:Tag List\\|Python\\)\\*" display-buffer-in-side-window
    (side . right) (slot . 0) (window-width . 0.2) (dedicated . t)
    (preserve-size . (t . nil)) ,parameters)
   ("^magit:" display-buffer-in-side-window
    (side . left) (slot . 3) (window-width . 0.2) (dedicated . t)
    (preserve-size . (t . nil)) ,parameters)
   ("\\*\\(?:help\\|grep\\|MATLAB\\|Completions\\)\\*\\|^*compilation\\|^*Flutter\\|^*pytest\\|^*docker-build-output\\|^* docker container"
    (display-buffer-reuse-window display-buffer-in-side-window)
    (side . top) (slot . -1) (preserve-size . (nil . t)) (window-height . 0.15) (dedicated . t)
    ,parameters)
   ("\\*\\(?:shell\\|vterm\\)\\*"
    (display-buffer-reuse-window display-buffer-in-side-window)
    (side . top) (slot . 1) (preserve-size . (nil . t)) (window-height . 0.15) (dedicated . t)
    ,parameters)))

(map! :leader "w x" #'window-toggle-side-windows)

(add-hook 'ediff-before-setup-hook (lambda () (select-frame (make-frame))))
#+END_SRC

* vterm
#+BEGIN_SRC emacs-lisp
;; vterm
(defun projectile-vterm ()
  (interactive)
  ;; (if (projectile-project-p)
  ;; if projectile-project-p is not nil and not dired-mode
  (if (and (projectile-project-p) (not (eq major-mode 'dired-mode)))
      (let* ((project (projectile-project-root)))
        (unless (require 'vterm nil 'noerror)
          (error "Package 'vterm' is not available"))
        (projectile-with-default-dir project
          (vterm "*vterm*")
          (vterm-send-string "cd .")
          (vterm-send-return)))
    (unless (require 'vterm nil 'noerror)
      (error "Package 'vterm' is not available"))
    (vterm "*vterm*")
    (vterm-send-string "cd .")
    (vterm-send-return)))

(map! "M-V" #'projectile-vterm)

(after! vterm
  (setq vterm-shell "zsh")
  (setq vterm-buffer-name-string "*vterm %s*"))
#+END_SRC

* org
#+BEGIN_SRC emacs-lisp
;; org
(after! org
  (map! :map org-mode-map :n "g k" #'org-up-element)
  (map! :map org-mode-map :n "g j" #'org-down-element)
  (map! :map org-mode-map :leader "j s" 'jupyter-org-insert-src-block)
  (map! :map org-mode-map :leader "j c" 'jupyter-org-clone-block)
  (setq org-agenda-files '("~/Dropbox/agenda.org"))
  (setq org-latex-hyperref-template nil)
  (add-to-list 'org-latex-packages-alist '("" "minted"))
  (setq org-latex-toc-command "\\tableofcontents \\clearpage")
  (setq org-latex-listings 'minted)
  (setq org-latex-minted-options
        '(("breaklines" "true")
          ("breakanywhere" "true")
          ("linenos" "true")
          ("gobble" "-8")
          ("xleftmargin" "20pt")
          ("bgcolor" "borlandbg")))

  (setq org-latex-pdf-process '("latexmk -pdflatex=xelatex -shell-escape -pdf %f"))

  (after! ox-latex
    (add-to-list 'org-latex-classes
                 '("extarticle"
                   "\\documentclass{extarticle}"
                   ("\\section{%s}" . "\\section*{%s}")
                   ("\\subsection{%s}" . "\\subsection*{%s}")
                   ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                   ("\\paragraph{%s}" . "\\paragraph*{%s}")
                   ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))))

  (setq org-src-fontify-natively t))

(use-package! org-ref
    :after org
    :init
    ; code to run before loading org-ref
    :config
    ; code to run after loading org-ref
    )


(use-package! websocket
    :after org-roam)

(use-package! org-roam-ui
    :after org-roam ;; or :after org
;;         normally we'd recommend hooking orui after org-roam, but since org-roam does not have
;;         a hookable mode anymore, you're advised to pick something yourself
;;         if you don't care about startup time, use
;;  :hook (after-init . org-roam-ui-mode)
    :config
    (setq org-roam-ui-sync-theme t
          org-roam-ui-follow t
          org-roam-ui-update-on-save t
          org-roam-ui-open-on-start t))

(setq org-journal-date-format "%a, %Y %b %d")

(use-package! olivetti
  :hook (org-mode . olivetti-mode))
#+END_SRC

* custom conf
#+BEGIN_SRC emacs-lisp
;; custom binds
(setq delete-by-moving-to-trash t)
(setq-default comment-line-break-function nil)

(global-set-key (kbd "H-M-J") (lambda()
                              (interactive)
                              (display-buffer-in-side-window (get-buffer (buffer-name)) '((side . top) (slot . -1) (window-height . 0.15)))))
(global-set-key (kbd "H-M-K") (lambda()
                              (interactive)
                              (display-buffer-in-side-window (get-buffer (buffer-name)) '((side . top) (slot . 1) (window-height . 0.15)))))
(global-set-key (kbd "H-M-L") (lambda()
                              (interactive)
                              (display-buffer-in-side-window (get-buffer (buffer-name)) '((side . right) (slot . 1) (window-width . 0.35)))))
(global-set-key (kbd "H-M-H") (lambda()
                              (interactive)
                              (display-buffer-in-side-window (get-buffer (buffer-name)) '((side . left) (slot . 1) (window-width . 0.2)))))

(defun open-nautilus ()
  (interactive)
  (call-process "nautilus" nil 0 nil "."))

(map! "C-c C-n" #'open-nautilus)

(defun open-term ()
  "Lists the contents of the current directory."
  (interactive)
  (call-process "st" nil 0 nil))

(defun open-terminal-in-project-root ()
  "Open default terminal in the project root."
  (interactive)
  (if (projectile-project-p)
      (let ((default-directory (projectile-project-root)))
        (open-term))
    (open-term)))
(map! "H-<return>" 'open-terminal-in-project-root)

(map! :i
      "C-?" #'undo-fu-only-redo)

(map! :i
      "C-M-/" #'undo-fu-only-redo-all)

(global-set-key (kbd "H-d") (lambda ()
                              (interactive)
                              (scroll-up 4)
                              (setq this-command 'next-line)
                              (forward-line 4)))
(global-set-key (kbd "H-u") (lambda ()
                              (interactive)
                              (scroll-down 4)
                              (setq this-command 'previous-line)
                              (forward-line -4)))

(defun switch-to-previous-buffer ()
  (interactive)
  (switch-to-buffer (other-buffer)))
(global-set-key (kbd "H-<tab>") 'switch-to-previous-buffer)

(defun my-ivy-read (prompt)
  (ivy-read prompt (seq-filter
                    (lambda (x) (and (or (string-match-p "^*compilation" x)
                                         (string-match-p "^*vterm" x)
                                         (string-match-p "^*Flutter" x)
                                         (string-match-p "^*Python" x)
                                         (string-match-p "^magit:" x))
                                     (not (string-equal (buffer-name) x))))
                    (mapcar #'buffer-name (buffer-list)))))

(defun ivy-compilation-buffers (&optional name)
  "Read desktop with a name."
  (interactive)
  (unless name
    (setq name (my-ivy-read "compilation buffers: ")))
  (switch-to-buffer name))

(global-set-key (kbd "H-x b") 'ivy-compilation-buffers)

(defun my-make-room-for-new-compilation-buffer ()
  "Renames existing *compilation* buffer to something unique so
         that a new compilation job can be run."
  (interactive)
  (let ((cbuf (get-buffer (concat "*compilation*<" (projectile-project-name) ">")))
        (more-cbufs t)
        (n 1)
        (new-cbuf-name ""))
    (when cbuf
      (while more-cbufs
        (setq new-cbuf-name (concat (format "*compilation %d*<" n) compile-command " " (projectile-project-name) ">"))
        (setq n (1+ n))
        (setq more-cbufs (get-buffer new-cbuf-name)))
      (with-current-buffer cbuf
        (rename-buffer new-cbuf-name)))))

(map! :leader "c n" #'my-make-room-for-new-compilation-buffer)
#+END_SRC

* remapping
#+BEGIN_SRC emacs-lisp
;; remaping

;; windows
(global-set-key (kbd "H-h") 'windmove-left)
(global-set-key (kbd "H-l") 'windmove-right)
(global-set-key (kbd "H-k") 'windmove-up)
(global-set-key (kbd "H-j") 'windmove-down)

(global-set-key (kbd "H-M-h") 'shrink-window-horizontally)
(global-set-key (kbd "H-M-l") 'enlarge-window-horizontally)
(global-set-key (kbd "H-M-k") 'enlarge-window)
(global-set-key (kbd "H-M-j") 'shrink-window)

(global-set-key (kbd "H-/") 'winner-undo)
(global-set-key (kbd "H-?") 'winner-redo)

;; Pull from PRIMARY (same as middle mouse click)
(defun get-primary ()
  (interactive)
  (insert
   (gui-get-primary-selection)))

(map! :n "*p" 'get-primary)

;; open file externally
(map! :leader "f o" #'counsel-find-file-extern)

;; workspaces
(map! :leader "TAB TAB" #'+workspace/other)
(map! :leader "TAB '" #'+workspace/display)
#+END_SRC
